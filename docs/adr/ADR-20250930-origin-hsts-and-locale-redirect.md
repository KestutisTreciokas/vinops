# ADR-20250930 — Периметр origin (nginx+Cloudflare), 308 /→/en и HSTS на краю

**ID/Дата (Europe/Warsaw):** ADR-20250930 · 2025-09-30 21:30  
**Статус:** Accepted

## Контекст
1) По проектному SSOT периметр origin — nginx; допускается Cloudflare proxy ON.  
2) Языковая политика — канон URL `/{lang}/…`; для корня `/` требуется единая точка входа.  
3) QA зафиксировал требование HSTS в S1-базисе; ранее HSTS временно откладывали, затем вернули для соблюдения базиса и безопасности.

## Решение (ЖЁСТКОЕ)
- Периметр: **origin nginx** под Cloudflare proxy ON (HTTP/2/3, Brotli, базовый WAF).  
- Локализация: **строгий 308** с `/` на `/en` (и любые пути без префикса `/en|/ru` → `/en{uri}`) — дубликатов контента нет, канон один.  
- **HSTS включён на краю (Cloudflare Transform/Ruleset)** минимум как:
  `Strict-Transport-Security: max-age=31536000` (без `includeSubDomains`, без `preload` на текущем этапе).
  Это гарантируется в ответах, включая 308 на `/`.

## Рассмотренные альтернативы
- 200 на `/` и авто-детект языка → отклонено: порождает дубль/хаос в hreflang, усложняет SEO.  
- HSTS только на origin → отклонено: редирект 308 на `/` проходит через край; заголовок должен быть на первом ответе.

## Последствия
- + SEO-чистота, предсказуемый краулинг, одноточечный канон.  
- + Безопасность: HSTS снижает риск MITM/SSL-stripping.  
- – Доп. RTT из-за 308 на `/` (минимально; можно компенсировать редиректом на краю CF).  
- – HSTS требует внимательности при обслуживании поддоменов (поэтому пока без includeSubDomains/preload).

## Правила миграции
1) Если когда-либо понадобится 200 на `/` — только через CR + SEO-миграцию (каноникал, hreflang, sitemap и смоки).  
2) Эскалация HSTS до `includeSubDomains; preload` — отдельный ADR после аудита всех субдоменов.  
3) Редирект `/→/en` держать на краю (CF) для мин. задержки; конфигурация origin должна быть совместима (дублирующий редирект допустим).

## Ссылки
- SSOT/SEO (канон `/{lang}/…`, hreflang, JSON-LD), SSOT/INFRA (nginx+CF), QA замечание про HSTS на 308.
