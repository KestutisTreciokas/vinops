#!/usr/bin/env bash
set +e +u
export TZ="Europe/Warsaw"

log(){ echo "[$(date +'%F %H:%M %Z')] $*"; }

ENV_FILE="/srv/vinops/.env"
[ -f "$ENV_FILE" ] || { echo "[FAIL] .env not found: $ENV_FILE"; exit 1; }
. "$ENV_FILE"

RELEASES_DIR="${RELEASES_DIR:-/srv/vinops/releases}"
CURRENT_SHA_FILE="${CURRENT_SHA_FILE:-$RELEASES_DIR/CURRENT_SHA}"
PREV_SHA_FILE="${PREV_SHA_FILE:-$RELEASES_DIR/PREV_SHA}"
PROD_HOST="${PROD_HOST:-vinops.online}"
DEV_HOST="${DEV_HOST:-dev.vinops.online}"

EVENT=; STATUS=; REF=; FROM=; TO=; ENVNAME=; NOTE=
while [ $# -gt 0 ]; do
  case "$1" in
    --event)  EVENT="$2"; shift 2;;
    --status) STATUS="$2"; shift 2;;
    --env)    ENVNAME="$2"; shift 2;;
    --ref)    REF="$2"; shift 2;;
    --from)   FROM="$2"; shift 2;;
    --to)     TO="$2"; shift 2;;
    --note)   NOTE="$2"; shift 2;;
    *) echo "[WARN] unknown arg: $1"; shift;;
  esac
done

ts="$(date +'%F %H:%M')"
cur="$(cat "$CURRENT_SHA_FILE" 2>/dev/null || true)"
prev="$(cat "$PREV_SHA_FILE" 2>/dev/null || true)"
[ -n "$REF" ] || REF="$cur"

NOTE_JSON="${NOTE//\"/\'}"

mkdir -p "$RELEASES_DIR" || true
REPO_DIR="/root/work/vinops.restore/docs/releases"
mkdir -p "$REPO_DIR" || true

CURRENT_JSON="$RELEASES_DIR/current.json"
cat >"$CURRENT_JSON" <<JSON
{
  "version": 1,
  "timestamp": "$ts",
  "current_sha": "$cur",
  "prev_sha": "$prev",
  "hosts": { "prod": "$PROD_HOST", "dev": "$DEV_HOST" },
  "last_event": { "type": "${EVENT:-unknown}", "status": "${STATUS:-unknown}", "env": "${ENVNAME:-unknown}", "ref": "$REF", "note": "${NOTE_JSON:-}" }
}
JSON
cp -f "$CURRENT_JSON" "$REPO_DIR/current.json" 2>/dev/null || true

REL_JSON="$RELEASES_DIR/release-$REF.json"
cat >"$REL_JSON" <<JSON
{
  "version": 1,
  "timestamp": "$ts",
  "sha": "$REF",
  "event": "${EVENT:-unknown}",
  "status": "${STATUS:-unknown}",
  "env": "${ENVNAME:-unknown}",
  "from_sha": "${FROM:-}",
  "to_sha": "${TO:-}",
  "current_after": "$cur",
  "prev_after": "$prev",
  "hosts": { "prod": "$PROD_HOST", "dev": "$DEV_HOST" },
  "build": { "id": null, "etag": null },
  "note": "${NOTE_JSON:-}"
}
JSON

cp -f "$REL_JSON" "$REPO_DIR/release-$REF.json" 2>/dev/null || true
log "artifacts written: $CURRENT_JSON ; $REL_JSON"
