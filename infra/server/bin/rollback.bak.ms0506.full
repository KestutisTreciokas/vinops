#!/usr/bin/env bash
# vinops rollback to PREV_SHA (state-file swap)

ENV_LOADED=""
try_env() { [ -n "$1" ] && [ -f "$1" ] && . "$1" && ENV_LOADED="$1"; }
try_env "${ENV_FILE:-}"
[ -z "$ENV_LOADED" ] && try_env "/srv/vinops/.env"
[ -z "$ENV_LOADED" ] && try_env "$(cd "$(dirname "$0")"/.. && pwd)/.env"

: "${TZ:=Europe/Warsaw}"
: "${RELEASES_DIR:=/srv/vinops/releases}"
: "${CURRENT_SHA_FILE:=${RELEASES_DIR}/CURRENT_SHA}"
: "${PREV_SHA_FILE:=${RELEASES_DIR}/PREV_SHA}"

ts() { date +'%F %H:%M %Z'; }

CUR="$(cat "$CURRENT_SHA_FILE" 2>/dev/null || true)"
PREV="$(cat "$PREV_SHA_FILE" 2>/dev/null || true)"
[ -z "$CUR" ]  && { echo "[FAIL] CURRENT_SHA empty"; exit 2; }
[ -z "$PREV" ] && { echo "[FAIL] PREV_SHA empty"; exit 3; }
[ -d "$RELEASES_DIR/$PREV" ] || { echo "[FAIL] prev release dir missing: $RELEASES_DIR/$PREV"; exit 4; }

echo "[$(ts)] rollback: $CUR -> $PREV"
echo "$CUR"  > "$PREV_SHA_FILE"
echo "$PREV" > "$CURRENT_SHA_FILE"
echo "[$(ts)] done: CURRENT_SHA=$(cat "$CURRENT_SHA_FILE") PREV_SHA=$(cat "$PREV_SHA_FILE")"
