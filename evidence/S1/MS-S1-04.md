# Evidence — MS-S1-04 (Warsaw)
- Timestamp: 2025-10-04 01:09

## DB server info
- Version: PostgreSQL 17.4 (Ubuntu 17.4-1.pgdg24.04+2) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 13.3.0-6ubuntu2~24.04) 13.3.0, 64-bit
- Server: 192.168.0.5:5432
- TZ: Europe/Moscow

## Applied migrations & SHA256
- 001_init.sql (lines=86) — sha256:5bf641fa974b9e3b2950c0821408bc543af87565441c2d70f8b515915a3908d9
- 002_audit_api.sql (lines=50) — sha256:da224a3f6499409933475ff80ee371adfc225c100a3a216cc0ad75fbccfa9ddd
- 003_roles.sql (lines=56) — sha256:743066044a56cefddfd04e4433cd73f9b49e503aa117c5dfe3209185cab4482b

## Objects snapshot
                  List of relations
 Schema |           Name           | Type  |  Owner   
--------+--------------------------+-------+----------
 tg_bot | audit                    | table | gen_user
 tg_bot | priv_test_20251004004905 | table | gen_user
 tg_bot | sessions                 | table | gen_user
 tg_bot | users                    | table | gen_user
(4 rows)


## Documentation alignment (added 2025-10-04 01:13 CEST)

### docs/db/migrations.md — ключевые разделы
- Заголовки: # Миграции — vinops-tg-bot (S1) ## TL;DR ## Правила ## Ссылки на текущие миграции (S1) 
- Идемпотентность: присутствуют маркеры `IF NOT EXISTS`, `CREATE OR REPLACE`, `DO $$ BEGIN … EXCEPTION WHEN duplicate_object … END $$`.
- Перечень миграций (S1): 001_init.sql, 002_audit_api.sql, 003_roles.sql — все файлы существуют.

### docs/db/operations.md — ключевые положения
- Бэкап: ежедневный `pg_dump -Fc`, шифрование **age**, хранилище `/srv/vinops/backups/postgres/vinops/%Y-%m-%d/`, ротация (7 дней).
- Получатель age: `age14gzudn5k6vfsgqr70z30ky6q2k8597a00e52ulxs2qs2jm0dhprqpeypza` (совпадает с .sops.yaml: `age14gzudn5k6vfsgqr70z30ky6q2k8597a00e52ulxs2qs2jm0dhprqpeypza`).
- Восстановление: раздел присутствует (grep по ключевым маркерам успешен).

### Итог сопоставления с DoD ("оформлены, не противоречат")
- [x] Migrations doc оформлен, содержит правила идемпотентности и перечень миграций.
- [x] Operations doc оформлен, содержит стратегию бэкапов/ротации/восстановления и ключи шифрования.
- [x] Противоречий между документами и конфигурацией (.sops.yaml) **не обнаружено** (AGE recipient совпадает).
